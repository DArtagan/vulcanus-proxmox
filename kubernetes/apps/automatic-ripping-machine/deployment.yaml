apiVersion: apps/v1
kind: Deployment
metadata:
  name: automatic-ripping-machine
  labels:
    app: automatic-ripping-machine
spec:
  selector:
    matchLabels:
      app: automatic-ripping-machine
  template:
    metadata:
      labels:
        app: automatic-ripping-machine
    spec:
      #initContainers:
      #  - name: set-up-config-files
      #    image: busybox
      #    command: ["sh", "-c", "rm -rf /mnt/destination/* && cp -r /mnt/source /mnt/destination/"]
      #    volumeMounts:
      #      - mountPath: /mnt/source
      #        name: config
      #      - mountPath: /mnt/destination
      #        name: data
      #        subPath: config
      containers:
        - name: automatic-ripping-machine
          image: automaticrippingmachine/automatic-ripping-machine:2.6.67 # {"$imagepolicy": "apps:automatic-ripping-machine"}
          #env:
          #  - name: ARM_UID
          #    value: "0"
          #  - name: ARM_GID
          #    value: "0"
          ports:
            - containerPort: 8080
          resources:
            limits:
              squat.ai/cdrom: 1
          volumeMounts:
            - mountPath: /etc/arm/config
              name: data
              subPath: config
            - mountPath: /lib/udev/rules.d/51-docker-arm.rules
              name: init-scripts
              subPath: 51-docker-arm.rules
            - mountPath: /etc/service/armui/run
              name: init-scripts
              subPath: armui.sh
            - mountPath: /etc/my_init.d/arm_user_files_setup.sh
              name: init-scripts
              subPath: arm_user_files_setup.sh
            - mountPath: /home/root/db
              name: data
              subPath: db
            - mountPath: /home/root/logs
              name: data
              subPath: logs
            - mountPath: /home/root/media
              name: video
              subPath: import/automatic-ripping-machine
            - mountPath: /home/root/audio
              name: audio
              subPath: import
      #securityContext:
      #  runAsUser: 1000
      #  runAsGroup: 1000
      #  fsGroup: 1000
      volumes:
        - name: audio
          persistentVolumeClaim:
            claimName: audio-rw-pvc
        - name: config
          configMap:
            name: automatic-ripping-machine
        - name: init-scripts
          configMap:
            name: automatic-ripping-machine-init-scripts
            items:
              - key: arm_user_files_setup.sh
                path: arm_user_files_setup.sh
              - key: 51-docker-arm.rules
                path: 51-docker-arm.rules
              - key: armui.sh
                path: armui.sh
        - name: data
          persistentVolumeClaim:
            claimName: automatic-ripping-machine-pvc
        - name: video
          persistentVolumeClaim:
            claimName: video-pvc
